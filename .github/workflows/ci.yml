# SPDX-License-Identifier: PMPL-1.0
# wagasm-ssg CI Pipeline - Pure WebAssembly Text SSG

name: WAT CI

permissions: read-all

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

env:
  WABT_VERSION: "1.0.34"
  WABT_CHECKSUM: "42342d6a1227a9ff27b4e4f0068d90f5c6581c81ff66889c36a2b1dbe2c4323c"
  DENO_VERSION: "2.1.4"

jobs:
  # ==========================================================================
  # Language Compliance (MUST pass - violations are fatal)
  # ==========================================================================
  language-compliance:
    name: Language Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Verify WAT-only in src/
        run: |
          echo "=== Checking for FORBIDDEN languages in src/ ==="
          forbidden=$(find src/ -type f \( \
            -name "*.ts" -o \
            -name "*.js" -o \
            -name "*.rs" -o \
            -name "*.py" -o \
            -name "*.as" \
          \) 2>/dev/null || true)
          if [ -n "$forbidden" ]; then
            echo "::error::FATAL: Found FORBIDDEN language files in src/"
            echo "$forbidden"
            echo ""
            echo "wagasm-ssg MUST be pure WAT. This is non-negotiable."
            exit 1
          fi
          echo "PASS: Only WAT files in src/"

      - name: Verify no AssemblyScript
        run: |
          echo "=== Checking for AssemblyScript ==="
          if grep -r "assemblyscript\|@assemblyscript" . --include="*.json" 2>/dev/null; then
            echo "::error::FATAL: AssemblyScript is FORBIDDEN (it's TypeScript in disguise)"
            exit 1
          fi
          echo "PASS: No AssemblyScript detected"

      - name: Verify host runtime is I/O only
        run: |
          echo "=== Checking host runtime ==="
          if [ -f runtime/host.ts ]; then
            # These patterns indicate SSG logic in the host
            if grep -qE 'parseMarkdown|renderTemplate|generateRoute|processContent' runtime/host.ts; then
              echo "::error::FATAL: Host runtime contains SSG logic"
              echo "The host MUST provide ONLY I/O (write_file, read_file, log)"
              exit 1
            fi
            # Warning for suspicious patterns (not fatal)
            if grep -qE 'generate|template|markdown|parse|route' runtime/host.ts; then
              echo "::warning::Host runtime has suspicious patterns - review manually"
            fi
          fi
          echo "PASS: Host runtime is I/O only"

  # ==========================================================================
  # Build & Validate
  # ==========================================================================
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: language-compliance
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install WABT (with checksum verification)
        run: |
          wget -q https://github.com/WebAssembly/wabt/releases/download/1.0.34/wabt-1.0.34-ubuntu.tar.gz
          echo "42342d6a1227a9ff27b4e4f0068d90f5c6581c81ff66889c36a2b1dbe2c4323c  wabt-1.0.34-ubuntu.tar.gz" | sha256sum -c -
          tar xzf wabt-1.0.34-ubuntu.tar.gz
          echo "$PWD/wabt-1.0.34/bin" >> $GITHUB_PATH

      - name: Compile WAT to WASM
        run: |
          echo "=== Compiling WAT ==="
          wat2wasm src/wagasm-ssg.wat -o src/wagasm-ssg.wasm
          echo "Compiled: src/wagasm-ssg.wasm"
          ls -la src/wagasm-ssg.wasm

      - name: Validate WASM
        run: |
          echo "=== Validating WASM ==="
          wasm-validate src/wagasm-ssg.wasm
          echo "PASS: WASM validation succeeded"

      - name: Show WASM info
        run: |
          echo "=== WASM Module Info ==="
          wasm-objdump -h src/wagasm-ssg.wasm

      - name: Build site
        run: |
          echo "=== Building site ==="
          deno run --allow-read --allow-write runtime/host.ts
          echo "Site generated in _site/"

      - name: Verify output
        run: |
          echo "=== Verifying output ==="
          if [ ! -f _site/index.html ]; then
            echo "::error::index.html not generated"
            exit 1
          fi
          echo "Generated files:"
          ls -la _site/
          echo ""
          echo "=== HTML preview ==="
          head -30 _site/index.html

      - name: Upload WASM artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wagasm-ssg-wasm
          path: src/wagasm-ssg.wasm

      - name: Upload site artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wagasm-ssg-site
          path: _site/

  # ==========================================================================
  # E2E Tests
  # ==========================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install WABT
        run: |
          wget -q "https://github.com/WebAssembly/wabt/releases/download/${WABT_VERSION}/wabt-${WABT_VERSION}-ubuntu.tar.gz"
          echo "${WABT_CHECKSUM}  wabt-${WABT_VERSION}-ubuntu.tar.gz" | sha256sum -c -
          tar xzf "wabt-${WABT_VERSION}-ubuntu.tar.gz"
          echo "$PWD/wabt-${WABT_VERSION}/bin" >> $GITHUB_PATH

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d0d4f39a4b7e17558f6e2bdcf03a0daef # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Install just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run E2E tests
        run: |
          echo "=== Running E2E tests ==="
          if [ -d tests/e2e ]; then
            for test in tests/e2e/*.sh; do
              if [ -f "$test" ]; then
                echo "Running: $test"
                bash "$test"
              fi
            done
          else
            echo "No E2E tests found"
          fi

  # ==========================================================================
  # Security Checks
  # ==========================================================================
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check SPDX headers
        run: |
          echo "=== Checking SPDX headers ==="
          missing=""
          for file in src/*.wat runtime/*.ts adapters/src/*.res; do
            if [ -f "$file" ]; then
              if ! grep -q "SPDX-License-Identifier" "$file"; then
                missing="$missing $file"
              fi
            fi
          done
          if [ -n "$missing" ]; then
            echo "::warning::Missing SPDX headers in:$missing"
          else
            echo "PASS: All source files have SPDX headers"
          fi

      - name: Check for potential secrets
        run: |
          echo "=== Checking for secrets ==="
          if grep -rE "(password|secret|api_key|token)\s*=\s*['\"][^'\"]+['\"]" . \
             --include="*.ts" --include="*.wat" --include="*.res" \
             2>/dev/null | grep -v "example\|test\|mock"; then
            echo "::warning::Potential secrets detected - review manually"
          else
            echo "PASS: No obvious secrets found"
          fi

      - name: Verify SHA-pinned actions
        run: |
          echo "=== Checking GitHub Actions SHA pins ==="
          if grep -rE "uses:\s+\w+/\w+@v[0-9]" .github/workflows/*.yml 2>/dev/null; then
            echo "::error::GitHub Actions using tag versions instead of SHA pins"
            exit 1
          fi
          echo "PASS: All actions are SHA-pinned"

  # ==========================================================================
  # Adapter Build (optional)
  # ==========================================================================
  adapter:
    name: Build Adapter
    runs-on: ubuntu-latest
    if: ${{ hashFiles('adapters/package.json') != '' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: adapters/package-lock.json

      - name: Install dependencies
        working-directory: adapters
        run: npm ci || npm install

      - name: Build adapter
        working-directory: adapters
        run: npm run build
